@page "/components/standard/value-loader"
@inject NavigationManager Navigation;

<section>
    <h2>Value Loader</h2>
    <p>The <code>&lt;ValueLoader&gt;</code> component displays an value after it is loaded with states for Loading, Completed, Error and Timeout.</p>
</section>
<section>
    <h3>Basic Usage</h3>
    <CodeBlock Lang="blazor">
        &lt;ValueLoader ValueModel="Employee" LoadData=@@LoadEmployee&gt;
            &lt;Display&gt
                &lt;div&gtFirst Name: @@context.Value.FirstName&lt;/div&gt
                &lt;div&gtLast Name: @@context.Value.LastName&lt;/div&gt
            &lt;/&lt;Display&gt
        &lt;/ValueLoader&gt;

        @@code {
            public async Task&lt;Employee?&gt; LoadEmployee()
            {
                // Real data loading goes here
                await Task.Delay(5000);
                return new Employee
                {
                    Uuid = Guid.NewGuid(),
                    FirstName = "John",
                    LastName = "Smith"
                };
            }
        }
    </CodeBlock>

    <div style="width: 200px;border: solid 1px;margin-bottom: 10px;">
        <ValueLoader ValueModel="Employee" LoadData=@LoadEmployee Size=@SpinnerSize @ref="_childComponent">
            <Display>
                <div>First Name: @context.Value.FirstName</div>
                <div>Last Name: @context.Value.LastName</div>
            </Display>
        </ValueLoader>
    </div>

    <h5>Try It Out</h5>
    <form class="tryitout" onsubmit="return false;">
        <div>
            <label>Load result:</label>
            <select @onchange="OnValueChange">
                <option value="@(LoadingState.Complete)">Successful run</option>
                <option value="@(LoadingState.Error)">Failed run</option>
                <option value="@(LoadingState.Timeout)">Timeout</option>
            </select>
        </div>

        <div>
            <label>Size:</label>
            <select @bind="SpinnerSize">
                <option value="@(SpinnerSize.Standard)">SpinnerSize.Standard</option>
                <option value="@(SpinnerSize.Small)">SpinnerSize.Small</option>
                <option value="@(SpinnerSize.Large)">SpinnerSize.Large</option>
            </select>
        </div>
    </form>
    
</section>
<section>
    <h3>Configuration</h3>
    <p>
        The type of the return model is passed via <code>ValueModel="Employee"</code>
    </p>
    <p>
        The method to load the data is passed via <code>LoadData=@@GetData</code>
    </p>
    <p>
        Can add custom CSS classes via the <code>CssClass</code> parameter
    </p>
    <p>
        Can override the Loading, Error and Timeout states by passing a child fragment called <code>&lt;LoadingIndicator&gt</code>, <code>&lt;ErrorIndicator&gt</code> or <code>&lt;TimeoutIndicator&gt</code>.
    </p>
    <p>
        The child fragment will receive a context of the following type:
        <CodeBlock Lang="C#">
            /// &lt;summary&gt;
            /// Context passed through to the child components
            /// &lt;/summary&gt;
            public class ValueLoaderContext {
                /// &lt;summary&gt;
                /// The loaded data value
                /// &lt;/summary&gt;
                public ValueModel? Value { get; set; }
                /// &lt;summary&gt;
                /// The size of the loading icon
                /// &lt;/summary&gt;
                public SpinnerSize Size { get; set; }
                /// &lt;summary&gt;
                /// A callback method to retry the load process
                /// &lt;/summary&gt;
                public Func&lt;Task&gt;? Reload { get; set; }
            }
        </CodeBlock>
    </p>
    <p>
        An example override of the TimeoutIndicator view showing how both the <code>Size</code> and <code>Reload</code> method are used from the <code>context</code>:
        <CodeBlock Lang="Blazor">
            &lt;TimeoutIndicator&gt;
                &lt;div&gt;
                    &lt;Icon CssClass=@@context.Size.ToString().ToLower() Key="loader-timeout" /&gt;
                &lt;/div&gt;
                &lt;div&gt;
                    Oh! This timed out, &lt;a href="" @@onclick="context?.Reload" @@onclick:preventDefault&gt;try again&lt;/a&gt;
                &lt;/div&gt;
            &lt;/&lt;TimeoutIndicator&gt;
        </CodeBlock>
    </p>

</section>

@code {
    public LoadingState Value { get; set; } = LoadingState.Complete;
    public SpinnerSize SpinnerSize { get; set; } = SpinnerSize.Standard;
    private ValueLoader<Employee>? _childComponent;

    async Task OnValueChange(ChangeEventArgs e)
    {
        if(e.Value != null)
        {
            Value = (LoadingState)Enum.Parse(typeof(LoadingState), e.Value.ToString(), true);
        }
        await _childComponent.Refresh();
        StateHasChanged();
    }

    public async Task<Employee?> LoadEmployee()
    {
        await Task.Delay(2000);

        if(Value == LoadingState.Error)
        {
            throw new Exception("Boom");
        }

        if (Value == LoadingState.Timeout)
        {
            throw new TaskCanceledException();
        }

        await Task.Delay(3000);
        return new Employee
        {
            Uuid = Guid.NewGuid(),
            FirstName = "John",
            LastName = "Smith"
        };
    }
}