{
  "$schema": "https://raw.githubusercontent.com/fmi-works/extra-dry-azure/main/infrastructure-schema.json",
  "version": "0.3.1",
  "subscription": {
    "name": "YellowJacket"
  },
  "group": {
    "name": "sample-$env"
  },
  "location": "centralus",
  "keyVault": {
    "name": "sample-$env-keyvault",
    "secrets": [
      {
        "name": "sample-dbms-admin-password",
        "contents": "password",
        "default": "{Generate-Password 30}"
      },
      {
        "name": "sample-webapp-agent-password",
        "contents": "password",
        "default": "{Generate-Password 30}"
      },
      {
        "name": "sample-webjob-agent-password",
        "contents": "password",
        "default": "{Generate-Password 30}"
      },
      {
        "name": "sample-powerbi-user-password",
        "contents": "password",
        "default": "{Generate-Password 12}"
      }
    ]
  },
  "storageAccounts": [
    {
      "name": "sample-$env-webjobs"
    }
  ],
  "serviceBus": {
    "name": "sample-$env-servicebus",
    "sku": "Basic",
    "queues": [
      {
        "name": "warehouse-update"
      }
    ],
    "authorization": [
      {
        "name": "webjob-agent",
        "send": true,
        "listen": true,
        "manage": false
      },
      {
        "name": "webapp-agent",
        "send": true,
        "listen": false,
        "manage": false
      }
    ]
  },
  "dbms": {
    "name": "sample-$env-dbms",
    "username": "sample-dbms-admin",
    "password": "{Get-Secret 'sample-dbms-admin-password'}",
    "users": [
      {
        "name": "sample-webapp-agent",
        "password": "{Get-Secret 'sample-webapp-agent-password'}"
      },
      {
        "name": "sample-webjob-agent",
        "password": "{Get-Secret 'sample-webjob-agent-password'}"
      },
      {
        "name": "sample-powerbi-user",
        "password": "{Get-Secret 'sample-powerbi-user-password'}"
      }
    ],
    "firewall": [
      {
        "name": "AllowAllWindowsAzureIps",
        "value": "0.0.0.0"
      },
      {
        "name": "My Creator's IP",
        "value": "{Get-LocalIPAddress}"
      }
    ],
    "databases": [
      {
        "name": "sample-$env-database",
        "users": [
          {
            "username": "sample-webapp-agent",
            "roles": [ "db_datareader", "db_datawriter", "db_executor" ]
          },
          {
            "username": "sample-webjob-agent",
            "roles": [ "db_datareader" ]
          }
        ]
      },
      {
        "name": "sample-$env-warehouse",
        "users": [
          {
            "username": "sample-webapp-agent",
            "roles": [ "db_datareader" ]
          },
          {
            "username": "sample-webjob-agent",
            "roles": [ "db_datareader", "db_datawriter", "db_executor", "db_owner" ]
          },
          {
            "username": "sample-powerbi-user",
            "roles": [ "db_datareader" ]
          }
        ]
      }
    ]
  },
  "appServicePlan": {
    "name": "YellowJacketWebShared",
    "group": "YellowJacketWebDev",
    "appService": {
      "name": "sample-$env-webapp",
      "connectionStrings": [
        {
          "name": "AzureWebJobsStorage",
          "value": "{Get-StorageConnectionString 'sample-$env-webjobs'}"
        },
        {
          "name": "AzureWebJobsDashboard",
          "value": "{Get-StorageConnectionString 'sample-$env-webjobs'}"
        },
        {
          "name": "WebAppOltpDatabase",
          "type": "SqlServer",
          "value": "{Get-SqlConnectionString 'sample-$env-database' 'sample-webapp-agent' (Get-Secret 'sample-webapp-agent-password')}"
        },
        {
          "name": "WebAppOlapDatabase",
          "type": "SqlServer",
          "value": "{Get-SqlConnectionString 'sample-$env-warehouse' 'sample-webapp-agent' (Get-Secret 'sample-webapp-agent-password')}"
        },
        {
          "name": "WebJobOltpDatabase",
          "type": "SqlServer",
          "value": "{Get-SqlConnectionString 'sample-$env-database' 'sample-webjob-agent' (Get-Secret 'sample-webjob-agent-password')}"
        },
        {
          "name": "WebJobOlapDatabase",
          "type": "SqlServer",
          "value": "{Get-SqlConnectionString 'sample-$env-warehouse' 'sample-webjob-agent' (Get-Secret 'sample-webjob-agent-password')}"
        },
        {
          "name": "WebAppServiceBus",
          "type": "Custom",
          "value": "{Get-ServiceBusConnectionString 'webapp-agent'}"
        },
        {
          "name": "AzureWebJobsServiceBus",
          "type": "Custom",
          "value": "{Get-ServiceBusConnectionString 'webjob-agent'}"
        }
      ],
      "environmentVariables": [
        {
          "name": "ASPNETCORE_ENVIRONMENT",
          "value": "{Get-AspNetEnvironment '$env'}"
        }
      ]
    }
  }
}
